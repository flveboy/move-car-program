<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>车主后台 - 扫码挪车</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body{font-family:'PingFang SC','Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#1e88e5 0%,#0d47a1 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .card{width:100%;max-width:400px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:30px;text-align:center}
    h1{color:#1565c0;margin-bottom:10px;font-size:24px}
    .tip{font-size:14px;color:#757575;margin-bottom:20px}
    input{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:15px;font-size:16px}
    button{background:#1E88E5;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;cursor:pointer;transition:all .3s}
    button:hover{background:#1976d2;transform:translateY(-2px)}
    button:disabled{background:#90caf9;cursor:not-allowed;transform:none}
    .hidden{display:none}
    .qrcode-item{background:#f5f5f5;border-radius:10px;padding:15px;margin-bottom:15px;text-align:left}
    .qrcode-item h3{margin:0 0 10px;color:#1565c0}
    .qrcode-item p{margin:5px 0;font-size:14px;color:#616161}
    .qrcode-item button{margin-right:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>车主后台</h1>
    <p class="tip">注册或登录后管理您的挪车码</p>

    <!-- 登录表单 -->
    <div id="loginForm">
      <input id="phone" type="tel" placeholder="手机号">
      <input id="pwd" type="password" placeholder="密码">
      <button onclick="login()">登录</button>
      <p style="margin-top: 15px; font-size: 14px;">还没账号？<a href="#" onclick="showRegister()">立即注册</a></p>
    </div>

    <!-- 注册表单 -->
    <div id="registerForm" class="hidden">
      <input id="regPhone" type="tel" placeholder="手机号">
      <input id="regName" type="text" placeholder="姓名">
      <input id="regPwd" type="password" placeholder="密码">
      <input id="smsCode" type="text" placeholder="验证码（demo用123456）">
      <button onclick="register()">注册</button>
      <p style="margin-top: 15px; font-size: 14px;">已有账号？<a href="#" onclick="showLogin()">立即登录</a></p>
    </div>

    <!-- 后台功能 -->
    <div id="dashboard" class="hidden">
      <h2>欢迎您，<span id="userName"></span></h2>
      <button onclick="showAddCar()">添加车辆</button>
      <button onclick="showGenerateCode()">生成挪车码</button>
      <button onclick="listCodes()">查看码列表</button>
      <button onclick="logout()">退出登录</button>

      <!-- 添加车辆 -->
      <div id="addCarForm" class="hidden" style="margin-top: 20px;">
        <input id="plate" placeholder="车牌号">
        <input id="carPhone" placeholder="挪车电话">
        <button onclick="addCar()">添加</button>
      </div>

      <!-- 生成码 -->
      <div id="generateForm" class="hidden" style="margin-top: 20px;">
        <select id="carSelect"></select>
        <input id="limitDay" type="number" placeholder="每日限次（0=不限）" value="3">
        <input id="limitTotal" type="number" placeholder="终身限次（0=不限）" value="100">
        <button onclick="generateCode()">生成</button>
        <div id="qrcode" class="hidden" style="margin-top: 20px;"></div>
      </div>

      <!-- 码列表 -->
      <div id="codeList" class="hidden" style="margin-top: 20px;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    let token = localStorage.getItem('token');
    let currentCarId = '';

    /* ====== 登录/注册切换 ====== */
    function showRegister() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }
    function showLogin() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }
    function showDashboard() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
    }

    /* ====== 登录 ====== */
    async function login() {
      const phone = document.getElementById('phone').value;
      const pwd = document.getElementById('pwd').value;
      const res = await fetch('/api/owner/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone, pwd })
      });
      const data = await res.json();
      if (data.success) {
        token = data.token;
        localStorage.setItem('token', token);
        document.getElementById('userName').textContent = phone;
        showDashboard();
      } else {
        alert(data.error);
      }
    }

    /* ====== 注册 ====== */
    async function register() {
      const phone = document.getElementById('regPhone').value;
      const name = document.getElementById('regName').value;
      const pwd = document.getElementById('regPwd').value;
      const smsCode = document.getElementById('smsCode').value;
      const res = await fetch('/api/owner/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone, name, pwd, smsCode })
      });
      const data = await res.json();
      if (data.success) {
        token = data.token;
        localStorage.setItem('token', token);
        document.getElementById('userName').textContent = name;
        showDashboard();
      } else {
        alert(data.error);
      }
    }

    /* ====== 退出登录 ====== */
    function logout() {
      localStorage.removeItem('token');
      location.reload();
    }

    /* ====== 添加车辆 ====== */
    function showAddCar() {
      document.getElementById('addCarForm').classList.toggle('hidden');
    }
    async function addCar() {
      const plate = document.getElementById('plate').value;
      const phone = document.getElementById('carPhone').value;
      const res = await fetch('/api/car/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ token, plate, phone })
      });
      const data = await res.json();
      if (data.success) {
        alert('添加成功');
        document.getElementById('addCarForm').classList.add('hidden');
      } else {
        alert(data.error);
      }
    }

    /* ====== 生成码 ====== */
    function showGenerateCode() {
      document.getElementById('generateForm').classList.toggle('hidden');
      loadCars();
    }
    async function loadCars() {
      const res = await fetch('/api/car/list', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      const select = document.getElementById('carSelect');
      select.innerHTML = '';
      data.cars.forEach(car => {
        const opt = document.createElement('option');
        opt.value = car.id;
        opt.textContent = car.plate;
        select.appendChild(opt);
      });
    }
    async function generateCode() {
      const carId = document.getElementById('carSelect').value;
      const limitDay = document.getElementById('limitDay').value;
      const limitTotal = document.getElementById('limitTotal').value;
      const res = await fetch('/api/code/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ token, car_id: carId, limit_day: limitDay, limit_total: limitTotal })
      });
      const data = await res.json();
      if (data.success) {
        const code = data.code;
        const url = `${location.origin}/move.html?r=${code}`;
        document.getElementById('qrcode').classList.remove('hidden');
        document.getElementById('qrcode').innerHTML = '';
        new QRCode(document.getElementById('qrcode'), { text: url, width: 200, height: 200 });
        alert(`挪车码已生成：${code}\n请截图保存或打印`);
      } else {
        alert(data.error);
      }
    }

    /* ====== 码列表 ====== */
    async function listCodes() {
      document.getElementById('codeList').classList.remove('hidden');
      const res = await fetch('/api/code/list', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      const list = document.getElementById('codeList');
      list.innerHTML = '';
      data.list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'qrcode-item';
        div.innerHTML = `
          <h3>${item.code}</h3>
          <p>车牌：${item.car.plate}</p>
          <p>电话：${item.phone}</p>
          <p>状态：${item.status === 'enable' ? '启用' : '停用'}</p>
          <p>今日：${item.used_today}/${item.limit_day || '∞'} | 总计：${item.used_total}/${item.limit_total || '∞'}</p>
          <button onclick="toggleCode('${item.code}')">${item.status === 'enable' ? '停用' : '启用'}</button>
          <button onclick="viewRecords('${item.code}')">查看记录</button>
        `;
        list.appendChild(div);
      });
    }

    /* ====== 停用/启用码 ====== */
    async function toggleCode(code) {
      const res = await fetch('/api/code/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ token, code })
      });
      const data = await res.json();
      if (data.success) {
        alert(`已${data.status === 'enable' ? '启用' : '停用'}`);
        listCodes();
      } else {
        alert(data.error);
      }
    }

    /* ====== 查看记录 ====== */
    async function viewRecords(code) {
      const res = await fetch(`/api/code/records?code=${code}`);
      const data = await res.json();
      let html = '<h4>通知记录</h4>';
      data.list.forEach(rec => {
        html += `<p>${new Date(parseInt(rec.created_at)).toLocaleString()} - ${rec.type} - ${rec.message}</p>`;
      });
      document.getElementById('codeList').innerHTML = html;
    }

    /* ====== 初始化 ====== */
    (async () => {
      if (token) {
        // 验证 token 是否有效
        const res = await fetch('/api/owner/me', { headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('userName').textContent = data.owner.name;
          showDashboard();
        } else {
          localStorage.removeItem('token');
        }
      }
    })();
  </script>
</body>
</html>